const defaultSymbols=["*","#","@","&","%","$","!","+","=","•","○","◊","♦","♥","♠","♣"],hoverSymbols=["0","1","/","|","\\","<",">","^","v","~","-",":",";",".",",","`"],bgSymbols=[".","·","˙",":","°","`",",","'",'"',"_","-"];let audioContext,masterGainNode,oscillators={},lastPlayedTime=0,isAudioInitialized=!1,isCircleVisible=!1;const initAudio=()=>{if(!window.AudioContext&&!window.webkitAudioContext)return console.warn("Web Audio API не поддерживается в этом браузере"),!1;try{return audioContext=new(window.AudioContext||window.webkitAudioContext),masterGainNode=audioContext.createGain(),masterGainNode.gain.value=.1,masterGainNode.connect(audioContext.destination),isAudioInitialized=!0,!0}catch(e){return console.error("Ошибка при инициализации аудио:",e),!1}},playRelaxingSound=(e,t,i)=>{if(!isAudioInitialized)return;const o=Date.now();if(o-lastPlayedTime<100)return;lastPlayedTime=o;i.cols;const n=t/i.rows,a=[1,1.125,1.25,1.5,1.6875],l=220*a[Math.floor(n*a.length)],r=`osc-${Date.now()}`,s=audioContext.createOscillator(),c=audioContext.createGain();if(s.type="sine",s.frequency.value=l,c.gain.value=0,c.gain.setValueAtTime(0,audioContext.currentTime),c.gain.linearRampToValueAtTime(.2,audioContext.currentTime+.1),c.gain.linearRampToValueAtTime(0,audioContext.currentTime+1.5),s.connect(c),c.connect(masterGainNode),s.start(),oscillators[r]={oscillator:s,gainNode:c,endTime:audioContext.currentTime+1.5},setTimeout((()=>{oscillators[r]&&(oscillators[r].oscillator.stop(),delete oscillators[r])}),1500),Math.random()>.7){const e=`harmonic-${Date.now()}`,t=audioContext.createOscillator(),i=audioContext.createGain();t.type="sine",t.frequency.value=1.5*l,i.gain.value=0,i.gain.setValueAtTime(0,audioContext.currentTime),i.gain.linearRampToValueAtTime(.1,audioContext.currentTime+.2),i.gain.linearRampToValueAtTime(0,audioContext.currentTime+1.2),t.connect(i),i.connect(masterGainNode),t.start(),oscillators[e]={oscillator:t,gainNode:i,endTime:audioContext.currentTime+1.2},setTimeout((()=>{oscillators[e]&&(oscillators[e].oscillator.stop(),delete oscillators[e])}),1200)}},createStartPrompt=()=>{const e=document.getElementById("main-container"),t=document.createElement("div");t.id="start-prompt",t.textContent="прикоснись ко мне",e.appendChild(t),startBreathingAnimation(),t.addEventListener("click",(()=>{initAudio(),t.classList.add("fade-out"),setTimeout((()=>{t.style.display="none",showCircleWithAnimation()}),1e3)})),t.addEventListener("touchstart",(e=>{e.preventDefault(),initAudio(),t.classList.add("fade-out"),setTimeout((()=>{t.style.display="none",showCircleWithAnimation()}),1e3)}))},startBreathingAnimation=()=>{const e=document.getElementById("start-prompt");let t=1,i=1;const o=()=>{t+=.005*i,t>=1.1&&(i=-1),t<=.9&&(i=1),e.style.transform=`scale(${t})`,"none"!==e.style.display&&requestAnimationFrame(o)};requestAnimationFrame(o)},showCircleWithAnimation=()=>{createASCIICircle();const e=document.getElementById("ascii-circle");e.style.opacity="0",setTimeout((()=>{e.style.transition="opacity 2s ease-in-out",e.style.opacity="1",isCircleVisible=!0,document.addEventListener("mousemove",handleMouseMove,{passive:!0}),startSymbolFlickering()}),100)},createASCIICircle=()=>{const e=document.getElementById("main-container");let t=document.getElementById("ascii-circle");t||(t=document.createElement("div"),t.id="ascii-circle",e.appendChild(t)),t.innerHTML="";const i=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),o=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),n=Math.min(.8*Math.min(i,o),i<768?300:400),a=n/2,l=i<768?14:12,r=Math.floor(n/l),s=Math.floor(n/l);t.style.width=r*l+"px",t.style.height=s*l+"px";const c=document.createDocumentFragment(),d=[];for(let e=0;e<s;e++){d[e]=[];for(let t=0;t<r;t++){const i=t-r/2,o=e-s/2,n=Math.sqrt(i*i+o*o),c=Math.max(0,Math.min(1,2*(a/l*.85-n))),m=c>0;d[e][t]=m?c:0}}for(let e=0;e<s;e++)for(let t=0;t<r;t++){const i=document.createElement("div");if(d[e][t]>0){i.className="ascii-char";const o=Math.floor(Math.random()*defaultSymbols.length);i.textContent=defaultSymbols[o],i.style.opacity=d[e][t],i.dataset.x=t,i.dataset.y=e}else i.className="ascii-char",i.textContent=" ",i.style.pointerEvents="none";c.appendChild(i)}t.appendChild(c),window.circleMap=d,window.asciiCircleInfo={cols:r,rows:s,charSize:l,size:n}},startSymbolFlickering=()=>{const e=document.querySelectorAll(".ascii-char");let t=0;requestAnimationFrame((function i(o){if(o-t>100){t=o;const i=Math.ceil(.03*e.length),n=new Set;for(;n.size<i;){const t=Math.floor(Math.random()*e.length);n.add(t)}n.forEach((t=>{const i=e[t];if(i.style.opacity>0){const e=Math.floor(Math.random()*defaultSymbols.length);i.textContent=defaultSymbols[e];const t=Math.floor(200+55*Math.random());i.style.color=`rgb(${t}, 0, 0)`,setTimeout((()=>{i.style.color="red"}),300)}}))}isCircleVisible&&requestAnimationFrame(i)}))},handleMouseMove=(()=>{let e=!1,t=0,i=0;return o=>{isCircleVisible&&(t=o.clientX,i=o.clientY,e||(window.requestAnimationFrame((()=>{updateCirclePosition(t,i),e=!1})),e=!0))}})(),updateCirclePosition=(e,t)=>{if(!isCircleVisible)return;const i=document.getElementById("ascii-circle"),o=document.getElementById("main-container").getBoundingClientRect(),n=e-(o.left+o.width/2),a=t-(o.top+o.height/2),l=window.innerWidth<768?25:15,r=window.innerWidth<768?20:30,s=-n/l,c=-a/l,d=Math.max(-r,Math.min(r,s)),m=Math.max(-r,Math.min(r,c));i.style.transform=`translate(${d}px, ${m}px)`,updateSymbolsNearCursor(e,t,i)},updateSymbolsNearCursor=(()=>{let e=-100,t=-100;return(i,o,n)=>{if(!window.asciiCircleInfo||!isCircleVisible)return;const a=n.getBoundingClientRect(),l=i-a.left,r=o-a.top,s=Math.floor(l/window.asciiCircleInfo.charSize),c=Math.floor(r/window.asciiCircleInfo.charSize);if(Math.abs(s-e)<2&&Math.abs(c-t)<2)return;e=s,t=c;const d=document.querySelectorAll(".ascii-char"),{cols:m,rows:u}=window.asciiCircleInfo,h=window.innerWidth<768?3:4;for(let e=Math.max(0,c-h);e<Math.min(u,c+h);e++)for(let t=Math.max(0,s-h);t<Math.min(m,s+h);t++){const i=d[e*m+t];if(!i||i.style.opacity<=0)continue;const o=Math.sqrt(Math.pow(s-t,2)+Math.pow(c-e,2));if(o<h){isAudioInitialized&&o<2&&Math.random()>.7&&playRelaxingSound(t,e,window.asciiCircleInfo);const n=Math.floor(Math.random()*hoverSymbols.length);i.textContent=hoverSymbols[n],i.style.color="#ff5555",i.style.transform="scale(1.2)"}else"scale(1.2)"===i.style.transform&&setTimeout((()=>{const e=Math.floor(Math.random()*defaultSymbols.length);i.textContent=defaultSymbols[e],i.style.color="red",i.style.transform="scale(1)"}),300*Math.random())}}})(),resetCirclePosition=()=>{if(!isCircleVisible)return;document.getElementById("ascii-circle").style.transform="translate(0, 0)";document.querySelectorAll(".ascii-char").forEach((e=>{if("scale(1.2)"===e.style.transform){const t=Math.floor(Math.random()*defaultSymbols.length);e.textContent=defaultSymbols[t],e.style.color="red",e.style.transform="scale(1)"}}))},handleResize=()=>{window.resizeTimeout&&clearTimeout(window.resizeTimeout),window.resizeTimeout=setTimeout((()=>{isCircleVisible&&(createASCIICircle(),startSymbolFlickering())}),250)};window.onload=()=>{createStartPrompt(),window.addEventListener("resize",handleResize),document.addEventListener("touchmove",(e=>{isCircleVisible&&(e.preventDefault(),e.touches&&e.touches[0]&&handleMouseMove({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY}))}),{passive:!1})};